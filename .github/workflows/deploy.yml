name: ğŸš€ Deploy Prunaverso Web - Auto Portal

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'Modo de deployment'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - diagnostics-only

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout del Prunaverso
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Health Check Pre-Build
        run: npm run health-check
        continue-on-error: true
        
      - name: ğŸ“Š Generate Fractal Index
        run: node scripts/generate_fractal_index.cjs
        continue-on-error: true
        
      - name: ğŸ—ï¸ Build Portal Dual
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ğŸ”„ SPA Router Fix (404.html)
        run: cp dist/index.html dist/404.html
          
      - name: ï¿½ Build Stats
        run: |
          echo "ï¿½ğŸ“Š BUILD STATISTICS"
          echo "==================="
          ls -la dist/
          echo ""
          echo "ğŸ“ Asset sizes:"
          find dist -name "*.js" -exec ls -lh {} \; | awk '{print $5 " " $9}'
          echo ""
          echo "ğŸ¯ Total size:"
          du -sh dist/
          
      - name: ğŸ§¬ Post-Build Diagnostics
        if: ${{ github.event.inputs.deploy_mode == 'diagnostics-only' || github.event.inputs.deploy_mode == 'full' }}
        run: |
          echo "ğŸ” Verificando estructura del build..."
          ls -la dist/assets/ || echo "No assets folder"
          echo "ğŸ§ª Verificando index.html..."
          head -10 dist/index.html
          
      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
          
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: âœ… Deployment Success Notification
        run: |
          echo "ğŸ‰ Â¡PRUNAVERSO WEB DESPLEGADO CON Ã‰XITO!"
          echo "=========================="
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Timestamp: $(date)"
          echo "ğŸš€ Portal Dual activo y funcionando"
          echo ""
          echo "ğŸ§  CaracterÃ­sticas desplegadas:"
          echo "  - Portal Dev (modo arquitecto)"
          echo "  - Portal PÃºblico (modo narrativo)"
          echo "  - Sistema SISC cognitivo"
          echo "  - Gaming Controls integrados"
          echo "  - InfoOrbitales contextuales"
          echo ""
          echo "ğŸŒŸ El Prunaverso estÃ¡ vivo en internet!"